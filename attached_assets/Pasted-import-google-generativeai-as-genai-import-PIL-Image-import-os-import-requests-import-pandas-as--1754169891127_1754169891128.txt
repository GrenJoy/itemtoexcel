import google.generativeai as genai
import PIL.Image
import os
import requests
import pandas as pd
from datetime import datetime
import re
import json
import time
from typing import List, Dict, Optional
from collections import Counter # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Counter –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

class WarframeInventoryChecker:
    def __init__(self, gemini_api_key: str):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è Warframe."""
        genai.configure(api_key=gemini_api_key)
        self.model = genai.GenerativeModel('gemini-1.5-flash-latest')
        
        self.wfm_base_url = "https://api.warframe.market/v2"
        self.headers = {
            'Platform': 'pc', 'Language': 'ru', 'User-Agent': 'Warframe-Inventory-Checker/Updatable-v1'
        }
        
        self.items_cache = {}
        self.load_items_cache()

    def normalize_string(self, text: str) -> str:
        """–ü—Ä–∏–≤–æ–¥–∏—Ç —Å—Ç—Ä–æ–∫—É –∫ –µ–¥–∏–Ω–æ–º—É –≤–∏–¥—É: –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä, –∑–∞–º–µ–Ω–∞ —ë->–µ, —É–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã."""
        if not isinstance(text, str): return ""
        cleaned_text = text.lower().replace('—ë', '–µ').strip()
        cleaned_text = re.sub(r'\s*:\s*', ': ', cleaned_text)
        cleaned_text = re.sub(r'\s+', ' ', cleaned_text)
        return cleaned_text

    def load_items_cache(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–∑ WFM API (–∏—Å–ø–æ–ª—å–∑—É—è v2)."""
        try:
            print("–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–∑ Warframe Market...")
            response = requests.get(f"{self.wfm_base_url}/items", headers=self.headers, timeout=30)
            response.raise_for_status()
            items_list = response.json().get('data', [])
            for item in items_list:
                item_name_ru = item.get('i18n', {}).get('ru', {}).get('name')
                if item_name_ru:
                    self.items_cache[self.normalize_string(item_name_ru)] = item
            print(f"–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í –∫—ç—à–µ {len(self.items_cache)} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.")
        except Exception as e:
            print(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤: {e}")

    def analyze_inventory_screenshot(self, image_path: str) -> List[str]:
        """–ê–Ω–∞–ª–∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ —Å –ø–æ–º–æ—â—å—é Gemini —Å –≤–∞—à–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–º –ø—Ä–æ–º–ø—Ç–æ–º."""
        try:
            print(f"\n–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {os.path.basename(image_path)}")
            img = PIL.Image.open(image_path)
            
            # --- –í–ê–® –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–†–û–ú–ü–¢ ---
            prompt = """
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Ç–æ—á–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ –∏–∑ –∏–≥—Ä—ã Warframe.
            
            –ü–†–ê–í–ò–õ–ê:
            1.  –í—ã–ø–∏—Å—ã–≤–∞–π –∫–∞–∂–¥—ã–π –ø—Ä–µ–¥–º–µ—Ç –ù–ê –û–¢–î–ï–õ–¨–ù–û–ô –°–¢–†–û–ö–ï.
            2.  –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–æ —Å–ª–æ–≤–∞ "–ß–ï–†–¢–Å–ñ:", –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤ –æ—Ç–≤–µ—Ç–µ —É–¥–∞–ª–∏ —Å–ª–æ–≤–æ "–ß–ï–†–¢–ï–ñ:" –≤ –Ω–∞—á–∞–ª–µ –Ω–æ –¥–æ–±–∞–≤—å - "(–ß–µ—Ä—Ç–µ–∂)" –≤ –∫–æ–Ω—Ü–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä –±—ã–ª–æ –ß–ï–†–¢–ï–ñ: –õ–∞–≤–æ—Å –ü—Ä–∞–π–º: –°–∏—Å—Ç–µ–º–∞, –∞ —Å—Ç–∞–Ω–µ—Ç –õ–∞–≤–æ—Å –ü—Ä–∞–π–º: –°–∏—Å—Ç–µ–º–∞ (–ß–µ—Ä—Ç–µ–∂).
            3.  –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏—á–µ–≥–æ –æ—Ç —Å–µ–±—è. –ü—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä—É–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –º–æ–∂–Ω–æ —Ç–æ—á–Ω–µ–µ.
            
            –ü–†–ò–ú–ï–† –û–ñ–ò–î–ê–ï–ú–û–ì–û –í–´–í–û–î–ê:
            –ù–∞—É—Ç–∏–ª—É—Å –ü—Ä–∞–π–º: –ü–∞–Ω—Ü–∏—Ä—å
            –ù–∞—É—Ç–∏–ª—É—Å –ü—Ä–∞–π–º: –°–∏—Å—Ç–µ–º–∞
            –°–µ–≤–∞–≥–æ—Ç –ü—Ä–∞–π–º: –°–∏—Å—Ç–µ–º–∞ (–ß–µ—Ä—Ç–µ–∂)
            
            –ù–∞—á–∏–Ω–∞–π –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ:
            """
            response = self.model.generate_content([prompt, img])
            items_text = response.text.strip()
            items_list = [item.strip() for item in items_text.split('\n') if item.strip()]
            print(f"  > Gemini —Ä–∞—Å–ø–æ–∑–Ω–∞–ª {len(items_list)} —Å—Ç—Ä–æ–∫.")
            return items_list
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
            return []

    def find_item_slug(self, raw_item_name: str) -> Optional[str]:
        """–ò—â–µ—Ç slug –ø–æ —É–∂–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é."""
        # –ü–æ—Å–∫–æ–ª—å–∫—É Gemini —Ç–µ–ø–µ—Ä—å —Å–∞–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ, –ø–æ–∏—Å–∫ —É–ø—Ä–æ—â–∞–µ—Ç—Å—è
        normalized_name = self.normalize_string(raw_item_name)
        
        print(f"–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: '{raw_item_name}'. –ò—â–µ–º –≤ –∫—ç—à–µ: '{normalized_name}'")
        
        if normalized_name in self.items_cache:
            item_data = self.items_cache[normalized_name]
            item_slug = item_data.get("slug")
            print(f"  ‚úÖ –ù–ê–ô–î–ï–ù: '{normalized_name}' -> slug: '{item_slug}'")
            return item_slug
        else:
            print(f"  ‚ùå –ù–ï –ù–ê–ô–î–ï–ù.")
            return None

    def get_item_prices(self, item_slug: str) -> Dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–æ –µ–≥–æ slug."""
        url = f"{self.wfm_base_url}/orders/item/{item_slug}/top"
        print(f"  > –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ü–µ–Ω—ã –ø–æ URL: {url}")
        try:
            response = requests.get(url, headers=self.headers, timeout=15)
            response.raise_for_status() 
            data = response.json().get('data', {})
            sell_orders = data.get('sell', [])
            buy_orders = data.get('buy', [])
            sell_prices = [order['platinum'] for order in sell_orders]
            buy_prices = [order['platinum'] for order in buy_orders]
            print(f"  > ‚úÖ –£—Å–ø–µ—Ö! –ù–∞–π–¥–µ–Ω–æ —Ü–µ–Ω: –ü—Ä–æ–¥–∞–∂–∞ - {len(sell_prices)}, –ü–æ–∫—É–ø–∫–∞ - {len(buy_prices)}")
            return {
                'buy_prices': buy_prices, 'sell_prices': sell_prices,
                'avg_buy': round(sum(buy_prices) / len(buy_prices), 2) if buy_prices else 0,
                'avg_sell': round(sum(sell_prices) / len(sell_prices), 2) if sell_prices else 0
            }
        except Exception as e:
            print(f"  ‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ü–µ–Ω –¥–ª—è {item_slug}: {e}")
        time.sleep(0.5) 
        return {'buy_prices': [], 'sell_prices': [], 'avg_buy': 0, 'avg_sell': 0}

    def process_and_update_inventory(self, image_paths: List[str], inventory_file_path: str) -> pd.DataFrame:
        """
        –ù–û–í–ê–Ø –£–õ–£–ß–®–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:
        1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Excel, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å.
        2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞.
        3. –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–µ–¥–º–µ—Ç—ã –≤ DataFrame.
        4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π DataFrame –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
        """
        # 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞
        if os.path.exists(inventory_file_path):
            print(f"\n–ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å: {inventory_file_path}. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...")
            try:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º '–ù–∞–∑–≤–∞–Ω–∏–µ' –∫–∞–∫ –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
                df = pd.read_excel(inventory_file_path).set_index('–ù–∞–∑–≤–∞–Ω–∏–µ')
                if '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ' not in df.columns:
                    df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'] = 1 # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É, –µ—Å–ª–∏ –µ–µ –Ω–µ –±—ã–ª–æ
            except Exception as e:
                print(f"  > –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è Excel —Ñ–∞–π–ª–∞, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É. –û—à–∏–±–∫–∞: {e}")
                df = pd.DataFrame(columns=['–ù–∞–∑–≤–∞–Ω–∏–µ', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'Slug', '–¶–µ–Ω—ã –ø—Ä–æ–¥–∞–∂–∏', '–¶–µ–Ω—ã –ø–æ–∫—É–ø–∫–∏', '–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–∞–∂–∞', '–°—Ä–µ–¥–Ω—è—è –ø–æ–∫—É–ø–∫–∞', '–°—Å—ã–ª–∫–∞']).set_index('–ù–∞–∑–≤–∞–Ω–∏–µ')
        else:
            print(f"\n–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª '{inventory_file_path}' –Ω–µ –Ω–∞–π–¥–µ–Ω, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π.")
            df = pd.DataFrame(columns=['–ù–∞–∑–≤–∞–Ω–∏–µ', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'Slug', '–¶–µ–Ω—ã –ø—Ä–æ–¥–∞–∂–∏', '–¶–µ–Ω—ã –ø–æ–∫—É–ø–∫–∏', '–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–∞–∂–∞', '–°—Ä–µ–¥–Ω—è—è –ø–æ–∫—É–ø–∫–∞', '–°—Å—ã–ª–∫–∞']).set_index('–ù–∞–∑–≤–∞–Ω–∏–µ')

        # 2. –ê–Ω–∞–ª–∏–∑ –∏ –ø–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        all_item_names = []
        for image_path in image_paths:
            items = self.analyze_inventory_screenshot(image_path)
            all_item_names.extend(items)
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º Counter –¥–ª—è —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        item_counts = Counter(all_item_names)
        print(f"\n--- –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è {len(item_counts)} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–∑ –Ω–æ–≤—ã—Ö —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ ---")

        # 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
        for item_name, quantity in item_counts.items():
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –≤ DataFrame
            normalized_item_name_for_df_check = self.normalize_string(item_name)

            # –ò—â–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –∏–Ω–¥–µ–∫—Å–µ, —Ç.–∫. –º—ã –µ–≥–æ –Ω–µ –º–µ–Ω—è–ª–∏
            if item_name in df.index:
                # –ü—Ä–µ–¥–º–µ—Ç —É–∂–µ –µ—Å—Ç—å - –ø—Ä–æ—Å—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                print(f"–û–±–Ω–æ–≤–ª—è–µ–º: '{item_name}', –¥–æ–±–∞–≤–ª—è–µ–º {quantity} —à—Ç.")
                df.loc[item_name, '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'] += quantity
            else:
                # –ü—Ä–µ–¥–º–µ—Ç–∞ –Ω–µ—Ç - –∏—â–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
                print(f"–î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç: '{item_name}'")
                slug = self.find_item_slug(item_name)
                if slug:
                    prices = self.get_item_prices(slug)
                    new_row = {
                        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': quantity,
                        'Slug': slug,
                        '–¶–µ–Ω—ã –ø—Ä–æ–¥–∞–∂–∏': ', '.join(map(str, prices['sell_prices'])) or '–ù–µ—Ç',
                        '–¶–µ–Ω—ã –ø–æ–∫—É–ø–∫–∏': ', '.join(map(str, prices['buy_prices'])) or '–ù–µ—Ç',
                        '–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–∞–∂–∞': prices['avg_sell'],
                        '–°—Ä–µ–¥–Ω—è—è –ø–æ–∫—É–ø–∫–∞': prices['avg_buy'],
                        '–°—Å—ã–ª–∫–∞': f"https://warframe.market/ru/items/{slug}"
                    }
                else:
                    new_row = {'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': quantity, 'Slug': '–ù–ï –ù–ê–ô–î–ï–ù', '–¶–µ–Ω—ã –ø—Ä–æ–¥–∞–∂–∏': 'N/A', '–¶–µ–Ω—ã –ø–æ–∫—É–ø–∫–∏': 'N/A', '–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–∞–∂–∞': 0, '–°—Ä–µ–¥–Ω—è—è –ø–æ–∫—É–ø–∫–∞': 0, '–°—Å—ã–ª–∫–∞': 'N/A'}
                
                # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ DataFrame, –∏—Å–ø–æ–ª—å–∑—É—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è –∫–∞–∫ –∏–Ω–¥–µ–∫—Å
                df.loc[item_name] = new_row
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º DataFrame —Å —Å–±—Ä–æ—à–µ–Ω–Ω—ã–º –∏–Ω–¥–µ–∫—Å–æ–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        return df.reset_index()

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã."""
    # --- –ù–ê–°–¢–†–û–ô–ö–ò ---
    api_key = os.environ.get("GEMINI_API_KEY")
    if not api_key:
        api_key = input("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à API –∫–ª—é—á –¥–ª—è Gemini –∏ –Ω–∞–∂–º–∏—Ç–µ Enter: ")
    if not api_key: 
        print("API –∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω. –í—ã—Ö–æ–¥.")
        return

    # 1. –£–ö–ê–ñ–ò–¢–ï –ü–£–¢–¨ –ö –í–ê–®–ï–ú–£ –ì–õ–ê–í–ù–û–ú–£ –§–ê–ô–õ–£ –ò–ù–í–ï–ù–¢–ê–†–Ø
    # –≠—Ç–æ—Ç —Ñ–∞–π–ª –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è.
    inventory_file = "–º–æ–π_–ø–æ–ª–Ω—ã–π_–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.xlsx"

    # 2. –£–ö–ê–ñ–ò–¢–ï –ü–£–¢–ò –ö –ù–û–í–´–ú –°–ö–†–ò–ù–®–û–¢–ê–ú, –ö–û–¢–û–†–´–ï –ù–£–ñ–ù–û –î–û–ë–ê–í–ò–¢–¨
    new_screenshots = [
        r"C:\Users\alexu\Desktop\Warframe\items.jpg",
        # r"C:\–ø—É—Ç—å\–∫\–≤—Ç–æ—Ä–æ–º—É\–Ω–æ–≤–æ–º—É_—Å–∫—Ä–∏–Ω—à–æ—Ç—É.png",
    ]
    
    # --- –ó–ê–ü–£–°–ö ---
    valid_screenshots = [path for path in new_screenshots if os.path.exists(path)]
    if not valid_screenshots:
        print("!!! –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º –ø—É—Ç—è–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç–∏ –≤ `new_screenshots`.")
        return

    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—à —á–µ–∫–µ—Ä
        checker = WarframeInventoryChecker(gemini_api_key=api_key)
        if not checker.items_cache:
            print("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É.")
            return

        # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        final_df = checker.process_and_update_inventory(valid_screenshots, inventory_file)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π DataFrame
        # –°–Ω–∞—á–∞–ª–∞ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–æ–ª–æ–Ω–∫–∞ '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ' —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–∞—è
        final_df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'] = final_df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'].astype(int)
        
        final_df.to_excel(inventory_file, index=False, engine='openpyxl')
        print(f"\n‚úÖ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª: {os.path.abspath(inventory_file)}")
        
        # –í—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        print(f"\nüìä --- –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ---")
        found_count = len(final_df[final_df['Slug'] != '–ù–ï –ù–ê–ô–î–ï–ù'])
        total_count = len(final_df)
        print(f"–í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ: {total_count}")
        print(f"–£—Å–ø–µ—à–Ω–æ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ Warframe.market: {found_count}")
        
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å, —É–º–Ω–æ–∂–∞—è —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        total_value = (final_df['–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–∞–∂–∞'] * final_df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ']).sum()
        print(f"–û–±—â–∞—è –ø—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è: {total_value:.2f} –ø–ª–∞—Ç–∏–Ω—ã")

    except Exception as e:
        print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()

–í–æ—Ç –º–æ–π –∫–æ–¥ —Å –ª–æ–≥–∏–∫–æ–π. –ò—Ç–∞–∫ –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è (–≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ –ø—Ä–æ–º–ø—Ç) –∏ –¥–∞–µ—Ç –æ—Ç–≤–µ—Ç, –ø–æ—Ç–æ–º —ç—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç—ã –∏—â—É—Ç—Å—è –≤ –±–∞–∑–µ —á–µ—Ä–µ–∑ Api warframe market –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ, –∞–Ω–≥–ª –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—Å—ã–ª–∫–∞, –ø–æ—Ç–æ–º Order —ç—Ç–æ —Ü–µ–Ω–∞, —Ç–∞–º —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ. –ü–æ—Ç–æ–º —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ñ–∞–π–ª Excel (–ø—Ä–∏–º–µ—Ä –Ω–∞ —Ñ–æ—Ç–æ). –Ø —Ö–æ—á—É —á—Ç–æ–±—ã –≤—Å—è –ª–æ–≥–∏–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ –±—ã–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ –°–∞–π—Ç–µ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º –ª—é–¥—è–º. –ò–¢–ê–ö –î–ê–õ–¨–®–ï –í–ê–ñ–ù–û - "–Ø —Ö–æ—á—É —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Ä—É —Ñ–æ—Ç–æ–∫ (–±–µ—Å—Å–∫–æ–Ω–µ—á–Ω–æ) –∏–∏ –∏—Ö –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –±—É–¥–µ—Ç —Ç–∞–∫–∂–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å Excel —Å –Ω–∞–∑–≤, —Ü–µ–Ω–æ–π –∏ —Ç.–ø (–ø—Ä–∏–º–µ—Ä –Ω–∞ —Å–∫—Ä–∏–Ω–µ) –ù–û –µ—Å–ª–∏ –ø—Ä–µ–¥–º–µ—Ç –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è —Ç–æ –ø—Ä–æ—Å—Ç–æ –≤ —Å—Ç–æ–ª–±—Ü–µ "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" –±—É–¥–µ—Ç +1 –Ω–∞–ø—Ä–∏–º–µ—Ä 2, –ø–æ—Ç–æ–º –µ—Å–ª–∏ –ø—Ä–µ–¥–º–µ—Ç –µ—â–µ —Ä–∞–∑ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ —Ç–æ 3 –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ. –î–∞–ª—å—à–µ –õ—é–¥–∏ —Ç—Ä–µ–π–¥—è—Ç—Å—è —Å –∏–≥—Ä–æ–∫–∞–º–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø–æ-—ç—Ç–æ–º—É –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∫–∏–¥–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã —Ç—Ä–µ–π–¥–æ–≤ –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ Excel –§–∞–π–ª—ã –Ω–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ —Ç—è–∂–µ–ª–æ –∏ –∑–∞–ø—É—Ç–∞–Ω–æ –ø–æ-—ç—Ç–æ–º—É —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ —Ñ–∞–π–ª —Ç–æ –µ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∑–∏–ª Excel —Ñ–∞–π–ª –∏ –∫ –Ω–µ–º—É –î–û–ë–ê–í–ò–õ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã, –ò–ò —Å–Ω–æ–≤–∞ –≤—ã—Ç–∞—â–∏–ª –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ (–ø—Ä–∏–º–µ—Ä –Ω–∞ —Å–∫—Ä–∏–Ω–µ) –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª Excel —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–±–∞–≤–∏–≤ —Ç—É–¥–∞ –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã, –∞ –µ—Å–ª–∏ –ü—Ä–µ–¥–º–µ—Ç –£–ñ–ï –≤ —Ñ–∞–π–ª–µ excel —Ç–æ –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ +1 –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —Å—Ç–æ–ª–±—Ü–µ. 